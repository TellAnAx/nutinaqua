---
title: "Nutrient Contribution"
subtitle: "Assessment of contributions based on estimated assumptions"
author: "Anıl A. Tellbüscher"
date: "Last updated: `r format(Sys.Date(), '%d.%m.%Y')`"
output: 
  pdf_document:
    includes:
      in_header: ../latex/preamble.tex
    toc: true
---

```{r setup, include=FALSE}
# RMarkdown options
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	include = FALSE
)

# R options
options(knitr.kable.NA = "")

# Load packages
library(here)
library(rlang)
library(readxl)
library(tidyverse)
library(httr)
library(rstatix)
library(NADA)
library(PeriodicTable)
library(ggmap)
library(gdata)
library(viridis)
library(RColorBrewer)
library(bookdown)
library(png)
library(tellbuschR) # Install from GitHub TellAnAx/tellbuschR with GitHub token for authentication

# Load functions
source(here("R", "plot_functions.R"))
source(here("R", "helper_functions.R"))
```



# To Do

- **Permutations**
- **update table construction in Feeding as nutrient source**



# Data import

|File|
|---|
|Feed composition APO-SUB-2.xlsx|
|Water quality APO-SUB-2.xlsx|
|IAFFD FICD.xlsx|



```{r import_data}
source(here("R", "import_data.R"))
```



# Data wrangling

```{r model_system}
source(here("R", "assumptions.R"))
```

```{r data_wrangling}
source(here("R", "data_wrangling.R"))
```

```{r plot_functions}
source(here("R", "plot_functions.R"))
```



# Results

```{r}
results <- list()
tables <- list()
```



## Feed(-ing) as nutrient source


```{r}
data$feed_cleaned <- data$feed[[1]] %>% 
  
  # remove broodstock feeds
  filter(feed_cat3 != "broodstock") %>% 
  
  # create additional data identifier
  mutate(
    N_gkg = CP*1e3/6.25,
    cat2 = case_when(
      cat1=="commercial" ~ "commercial",
      cat1=="experimental" ~ "experimental"
      ),
    cat2 = if_else(grepl("Tacon", ref_id),"old",cat2),
    cat2 = if_else(grepl("aquaponic",target_system),"aquaponic",cat2)
    ) %>% 
  
  # remove unnecessary data
  select(cat2, P_gkg:Cu_mgkg, N_gkg) %>% 
  
  # write data for statistical analysis
  write_rds(here("output", "interm", "feed_stattest.rds")) %>% 
  
  
  create_plot_data() %>% 
  
  # remove missing data
  drop_na(value) %>% 
  
  # split single column into two columns
  separate(name, into = c("substance", "unit"), sep = "_") %>%
  
  # Conversion of mg/kg to mol/kg
  mutate(
    value = if_else(unit == "mgkg", value*1e-3, value),
    unit = if_else(unit == "mgkg", "gkg", unit),
    molmass = map_dbl(convert_formula(substance), ~ sum(mass(.x))),
    value = value/molmass,
    unit = if_else(unit == "gkg", "molkg", unit),
    ) %>% 
  print()
```

```{r}
data$feed_cleaned %>% 
  group_by(cat2,substance) %>% 
  summarise(
    mean = mean(value),
    sd = sd(value),
    n = n()
  ) %>% 
  pivot_wider(names_from = cat2, values_from = c(mean, sd, n))
```

```{r}
data$feed_stat <- read_rds(here("output", "interm", "feed_stattest.rds"))

summary(data$feed_stat)

# enough data for reliable comparison
results$feed_comp_N <- data$feed_stat %>% tukey_hsd(N_gkg~cat2) %>% print()
results$feed_comp_P <- data$feed_stat %>% tukey_hsd(P_gkg~cat2) %>% print()

# almost no data - many NAs
results$feed_comp_K <- data$feed_stat %>% tukey_hsd(K_gkg~cat2) %>% print()
results$feed_comp_Ca <- data$feed_stat %>% tukey_hsd(Ca_gkg~cat2) %>% print()
results$feed_comp_Mg <- data$feed_stat %>% tukey_hsd(Mg_gkg~cat2) %>% print()
results$feed_comp_S <- data$feed_stat %>% tukey_hsd(S_gkg~cat2) %>% print()
results$feed_comp_Fe <- data$feed_stat %>% tukey_hsd(Fe_mgkg~cat2) %>% print()
results$feed_comp_Cu <- data$feed_stat %>% tukey_hsd(Cu_mgkg~cat2) %>% print()
results$feed_comp_Zn <- data$feed_stat %>% tukey_hsd(Zn_mgkg~cat2) %>% print()
```


```{r, eval=FALSE, include=FALSE}
data$feed_stat <- read_rds(here("output", "interm", "feed_stattest.rds"))

col_names <- colnames(data$feed_stat)
data$feed_stat$cat2


for(name in 2:length(col_names)) {
  print(name)
  
  data$feed_stat %>% 
    tukey_hsd()
    
  #data$feed_stat %>% 
    tukey_hsd(data$feed_stat[,name] ~ data$feed_stat$cat2) %>% print()
  
  if(!is.na(data$feed_stat[,name])){ # (FIXIT) returns vector instead of single logical
    tukey_hsd(data$feed_stat[,name] ~ data$feed_stat$cat2) %>% print()
  } else {
    next
  }
}
```

```{r data_commercial, eval=FALSE, include=FALSE}
data_commercial <- data$feed_cleaned %>% 
  filter(cat2 == "commercial") %>% 
  group_by(substance, unit) %>% 
  summarise(
    n = n(),
    min = min(value, na.rm = TRUE),
    q1 = quantile(value, na.rm = TRUE, 0.25),
    q2 = quantile(value, na.rm = TRUE, 0.5),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    cv = sd/mean*100,
    q3 = quantile(value, na.rm = TRUE, 0.75),
    max = max(value, na.rm = TRUE)
    ) %>% 
  print()
```

```{r feed_tukey}
stat_results <- list()
substances <- unique(data$feed_cleaned$substance)

for(i in 1:length(substances)) {
  stat_results[[i]] <- data$feed_cleaned %>% 
  filter(substance == substances[i]) %>% 
  rstatix::tukey_hsd(value~cat2)
}
names(stat_results) <- substances
```

```{r plot_commercial_density, eval=FALSE, include=FALSE}
data$feed_commercial %>% 
  create_plot_data() %>% 
  filter(!target_system %in% c("aquaponics", "pond", "cage")) %>%
  select(c(producer:feed_category4, name:value)) %>% 
  plot_feed_comp()

ggsave(here("output", "plots", "feed_composition_commercial.png"))
```

```{r data_commercial_special, eval=FALSE, include=FALSE}
data$feed_cleaned %>% 
  filter(cat2 == "aquaponic") %>% 
  group_by(substance, unit) %>% 
  summarise(
    n = n(),
    min = min(value, na.rm = TRUE),
    q1 = quantile(value, na.rm = TRUE, 0.25),
    q2 = quantile(value, na.rm = TRUE, 0.5),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    cv = sd/mean*100,
    q3 = quantile(value, na.rm = TRUE, 0.75),
    max = max(value, na.rm = TRUE)
    ) %>% 
  print()
```



### Aquaponics feeds

```{r, eval=FALSE, include=FALSE}
data$feed_commercial[[1]] %>% 
  create_plot_data() %>% 
  filter(!target_system %in% c("pond", "cage")) %>% 
  select(c(producer:feed_category4, name:value)) %>% 
  drop_na(value) %>% 
  mutate(target_system = if_else(is.na(target_system),"not specified",target_system)) %>% 
  filter(name == "P_gkg") %>% 
  rstatix::t_test(value ~ target_system)
```

```{r, eval=FALSE, include=FALSE}
data$feed_commercial[[1]] %>% 
  create_plot_data() %>% 
  filter(target_system %in% c("aquaponics")) %>% 
  select(c(producer:feed_category4, name:value)) %>% 
  plot_feed_comp()

ggsave(here("output", "plots", "feed_composition_commercial.png"))
```



### Experimental feeds

```{r data_experimental_studies, eval=FALSE, include=FALSE}
data$feed_cleaned %>% 
  filter(cat2 == "experimental") %>% 
  group_by(substance, unit) %>% 
  summarise(
    n = n(),
    min = min(value, na.rm = TRUE),
    q1 = quantile(value, na.rm = TRUE, 0.25),
    q2 = quantile(value, na.rm = TRUE, 0.5),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    cv = sd/mean*100,
    q3 = quantile(value, na.rm = TRUE, 0.75),
    max = max(value, na.rm = TRUE)
    ) %>% 
  print()
```

```{r, eval=FALSE, include=FALSE}
bind_rows(list(commercial = data_commercial, experimental = data_experimental), .id = "source") %>% 
  t_test(Mg_gkg ~ source)
```

```{r, eval=FALSE, include=FALSE}
data$feed_experimental[[1]] %>% 
  create_plot_data() %>% 
  plot_feed_comp()

knitr::include_graphics(here("output", "plots", "feed_composition.png"))
```



### Variability

```{r include=TRUE}
knitr::include_graphics(here("output", "plots", "feedstuff_composition.png"))
```


```{r eval=FALSE, include=FALSE}
 



  
  
  group_by(analyte, class) %>% 
  summarise(mean=mean(value, na.rm=T),
            sd=sd(value,na.rm=T),
            cv=sd/mean*100,
            n = n()) %>% 
  arrange(mean)
  mutate(across(where(is.numeric), ~ num(., digits = 3))) %>% 
  filter(n > 4) %>% 
  pivot_wider(names_from = analyte, values_from = mean:cv)
```





## Water as Nutrient Source

### Data origin

```{r create_water_map}
source(here("R", "plots", "map_plots.R"))
source(here("R", "plots", "water_plots.R"))
```

```{r}
knitr::include_graphics(here("output", "plots", "map.png"))
```


```{r}
results$n_wateranalysis <- nrow(gps_coordinates[,which("source" == "tap")])
results$n_wateranalysis_countries <- length(unique(gps_coordinates$country))
```



### Tap water

```{r}
results$n_observations_water_tap <- filter(data$water_cleaned, source == "tap") %>% nrow()
```

**FIXIT** CHECK ELEMENTAL CONVERSION STUFF

```{r tap}
data$water_cleaned_tap <- read_rds(here("output", "interm", "water_cleaned.rds")) %>% 
  
  # select only tap water
  filter(source == "tap") %>% 
  
  # remove irrelevant variables
  select(-c(ref_id:`EC_uS_cm_25degC`)) %>% 
  
  # convert concentrations
  mutate(
    NO3_mgL = sum(c(NO3_mgL*0.23, NO2_mgL*0.3, NH4_mgL*0.7), na.rm = TRUE), # convert to elemental N (TN_dissolved)    
    SO4_mgL = SO4_mgL*0.3, # convert SO4 to elemental S
    PO4_mgL = PO4_mgL*0.33 # convert PO4 to elemental P
  ) %>% 
  
  # convert to longtable
  pivot_longer(
    everything(),
  names_to = c("analyte", ".value"),
  names_pattern = "(.+)_(.+)*"
    ) %>% 
  
  rename(conc = "mgL") %>% 
  mutate(
    unit = "mgL",
    analyte = as.factor(analyte),
    belowLimit = as.logical(belowLimit)
    ) %>% 
  
  drop_na() %>% 
  
  # summarise data
  group_by(analyte, unit) %>% 
  summarise(
    n = n(),
    min = min(conc, na.rm = TRUE),
    conf.025 = mean(cenmle(conc, belowLimit, dist = 'gaussian'))[c(3)],
    meanconf = mean(cenmle(conc, belowLimit, dist = 'gaussian'))[c(1)],
    sd = sd(conc),
    cv = sd/meanconf*100,
    conf.975 = mean(cenmle(conc, belowLimit, dist = 'gaussian'))[c(4)],
    max = max(conc, na.rm = TRUE)
    ) %>% 
  
  mutate(
    analyte = if_else(analyte == "NO3", "N", analyte), # rename after conversion
    analyte = if_else(analyte == "SO4", "S", analyte), # rename after conversion
    analyte = if_else(analyte == "PO4", "P", analyte) # rename after conversion    
  ) %>% 
    
  #mutate(across(where(is.numeric), ~ num(., digits = 2))) %>% 
  arrange(desc(meanconf), cv) %>% 
    
  write_rds(here("output", "interm", "water_cleaned_tap.rds"))
```

```{r}
tables$water_tap <- read_rds(here("output", "interm", "water_cleaned_tap.rds")) %>% 
  select(analyte, unit, n, min, meanconf, sd, cv, max) %>% 
  table_styler() %>% 
  rename(mean = "meanconf") %>% 
  write_csv(here("output", "tables", "water_tap.csv"))
```

```{r include=TRUE}
knitr::kable(tables$water_tap,
             caption = paste0("Summary statistics of the chemical composition of tap water. Data was compiled from analysis reports of water supply companies (n = ", results$n_observations_water_tap, "). Mean values were estimated using accepted methods for censored data (Helsel, 2012). N is the sum of all nitrogenous species."))
```





### Rain water

```{r}
data$water_cleaned_rain <- read_rds(here("output", "interm", "water_cleaned.rds")) %>% 
  
  # remove tap water data
  filter(source == "rain") %>% 
  
  # remove irrelevant variables
  select(-matches("belowLimit")) %>% 
  select(-("ref_id":"aquaponics")) %>% 
  select(-c(pH, EC_uS_cm_25degC)) %>% 
  
  #rowwise() %>% 
    # convert concentrations
  mutate(
    N_mgL = sum(c(NO3_mgL*0.23, NO2_mgL*0.3, NH4_mgL*0.7), na.rm = TRUE), # convert to elemental N (TN_dissolved)
    S_mgL = SO4_mgL*0.3, # convert SO4 to elemental S
    P_mgL = PO4_mgL*0.33 # convert PO4 to elemental P
  ) %>% 
  
  # convert to long format
  pivot_longer(
    everything(),
    names_to = "names",
    values_to = "value"
  ) %>% 
  separate(names, into = c("analyte", "unit"), sep = "_") %>% 
  filter(!analyte %in% c("TOC", "NH4", "NO2", "NO3")) %>% 
  drop_na(value) %>% 
  print() %>% 
  write_rds(here("output", "interm", "water_cleaned_rain.rds"))
```

```{r}
knitr::include_graphics(here("output", "plots", "water_rain.png"))
```

- extreme outliers at the upper end --> NEED TO BE REMOVED!



```{r}
#
results$n_observations_water_rain <- filter(data$water_cleaned, source == "rain") %>% nrow()
# 
results$water_rain_threshold_removal <- 5
```

```{r}
# calculate Interquartile range
data$iqr_water_rain <- read_rds(here("output", "interm", "water_cleaned_rain.rds")) %>% 
  group_by(analyte, unit) %>% 
    summarise(iqr = IQR(value))


tables$water_rain <- read_rds(here("output", "interm", "water_cleaned_rain.rds")) %>% 
  
  # remove upper outliers
  left_join(data$iqr_water_rain) %>% 
  mutate(value = if_else(value > 1.5*iqr, NA, value)) %>% 
  drop_na(value) %>% 
  #filter(if_all(value, ~.x < quantile(.x, 0.95))) %>% # alternative for removal of upper X% of data
  
  group_by(analyte, unit) %>% 
  summarise(
    n = n(),
    min = min(value),
    Q1 = quantile(value, 0.25),
    mean = min(value),
    sd = sd(value),
    cv = sd/mean,
    Q3 = quantile(value, 0.75),
    max = max(value)
  ) %>% 
  
  # remove data with few observations
  filter(n > results$water_rain_threshold_removal) %>% 
  
  select(-c(Q1, Q3)) %>% 
  write_csv(here("output", "tables", "water_rain.csv"))
```

```{r include=TRUE}
knitr::kable(tables$water_rain,
             caption = paste0("Summary statistics of rainwater composition data (n = ", results$n_observations_water_rain, "). Analytes with less than ", results$water_rain_threshold_removal, " dataset records were removed. Outliers were identified by calculating the interquartile range (IQR). Values > 1.5 x IQR were removed from the dataset."))
```



### Combined

```{r}
data$water_combined_tap <- read_rds(here("output", "interm", "water_cleaned_tap.rds")) %>% 
  select(analyte, unit, conf.025, meanconf, conf.975)

data$water_combined_rain <- read_csv(here("output", "tables", "water_rain.csv")) %>% 
  select(analyte, unit, mean)



tables$water_combined <- data$water_combined_tap %>% 
  left_join(data$water_combined_rain) %>% 
  
  table_styler() %>% 
  
  mutate(significance = case_when(
    mean < conf.025 ~ "lower",
    mean > conf.025 & mean < conf.975 ~ "not significant",
    mean > conf.975 ~ "higher"
    )) %>% 
  
  select(-c(conf.025, conf.975)) %>% 
  
  rename(mean_tap = "meanconf", mean_rain = "mean") %>% 
  
  write_csv(here("output", "tables", "water_combined.csv"))
```

```{r include=TRUE}
knitr::kable(tables$water_combined,
             caption = paste0(""))
```




# Nutrient contribution
## Initial assumptions

```{r input_variables}
source(here("R", "assumptions.R"))
```

We assume a recirculation aquaculture system (RAS) has a total volume of `r print(totalV)` \si{\cubicm} of which `r print(rearingV)` \si{\cubicm} are used as rearing volume for the stock. Furthermore, we assume a stocking density of `r print(SD)` \si{\kg\per\cubicm}, referred to the rearing volume of the system. The feeding rate shall be set to `r print(FR)` \si{\p\per\d} of the total biomass and a water exchange rate of `r print(ER)` \si{\p\per\d} of the total system volume shall be maintained.

```{r echo=TRUE, results=FALSE}
# Calculate outputs
BM <- rearingV * SD       # Total biomass of stock (kg)
dailyFeed <- BM * (FR / 100)             # Total mass of feed per day (kg/day)
dailyFreshwater <- totalV * (ER / 100)   # Total volume of freshwater per day (m^3/day)
waterEx_perFeed <- (dailyFreshwater * 1e3) / dailyFeed   # Water exchange per feed unit (L/kg/day)
```

Based on these inputs, a biomass of `r print(BM)` \si{\kg}, a total weight of `r print(dailyFeed)` \si{\kg} feed fed per day, a daily exchanged volume of `r print(dailyFreshwater)` \si{\cubicm\per\d} freshwater and `r print(waterEx_perFeed)` \si{\L\per\kg} exchanged water per weight unit feed fed is calculated.

```{r include=FALSE}
results <- data.frame(Values = c(SD, FR, BM, dailyFeed, rearingV, totalV, ER, dailyFreshwater, waterEx_perFeed))

rownames(results) <- c(
  'Stocking density (kg/m^3)'
  ,'Feeding rate (%)'
  ,'Total biomass (kg)'
  ,'Daily feed fed (kg/day)'
  ,'Rearing unit volume (m^3)'
  ,'Total volume (m^3)'
  ,'Daily water exchange rate (%/m^3/day)'
  ,'Daily freshwater volume (m^3/day)'
  ,'Freshwater per feed (L/kg)'
)
```

```{r table_assumptions}
knitr::kable(results)
```





## Contribution
To estimate the mass contribution of source water and feed to the total amount of nutrients that are entering the system, it is assumed that the RAS operator is using tap water as freshwater source and analysis results from water treatment plants are thus taken as data input. Furthermore, the average of the nutrient profile of a number of commercial fish feeds is used.

### Feed

```{r}
assumption_data_feed <- read_excel(here("data", "APO-masterfile_nutrients.xlsx"), 
                                   sheet = 'feedIN', skip = 1) %>% 
  mutate(FR = as.numeric(sub("%","",FR)) / 100,
         CP = as.numeric(sub("%","",CP)) / 100) %>% 
  filter(!is.na(CP) & 
           !is.na(FR) &
           feed_name != "") %>% 
  group_by(feed_name) %>% 
  summarise(
    #Reference_ID = Reference_ID,
    FR = mean(FR),
    CP = mean(CP)) 

head(assumption_data_feed)
```

```{r include=FALSE}
# Load nutrient data
data <- read.csv2(here("data", "nutrient_contribution.csv"))

# Convert classes
data[,1] <- factor(data[,1], levels = c('N', 'P', 'K', 'Ca', 'Mg', 'S', 'B', 'Fe', 'Mn', 'Zn', 'Cu', 'Mo', 'Ni'))
data[,2:5] <- apply(data[,2:5], 2, as.numeric)
```



**To Do**
- Check average water quality data
- Check for more commercial feeds
- Group commercial feeds by fish species (is there a pattern?)


### Water

```{r}
read_excel(here("data", "APO - Water quality.xlsx"), sheet = "municipalTap", skip = 1) %>% 
  select(-c(Reference_ID:`EC_uS_cm_25degC`)) %>% 
  pivot_longer(
    everything(),
  names_to = c("nutrient", ".value"),
  names_pattern = "(.+)_(.+)*"
    ) %>% 
  mutate(nutrient = as.factor(nutrient),
         belowLimit = as.logical(belowLimit)) %>% 
  drop_na() %>% 
  filter(nutrient != "Al") %>% 
  group_by(nutrient) %>% 
  summarise(
    lconf = mean(cenmle(mgL, belowLimit, dist = 'gaussian'))[c(3)],
    mconf = mean(cenmle(mgL, belowLimit, dist = 'gaussian'))[c(1)],
    hconf = mean(cenmle(mgL, belowLimit, dist = 'gaussian'))[c(4)]
    )
```



## Permutation

```{r permutation_test}
fruits <- tibble(a = rnorm(100,3,2), b = rnorm(100, 9,4))

fruits %>% 
  expand(a,b) %>% 
  mutate(
    sum=a+b, 
    perc_a = a/sum*100, 
    perc_b = b/sum*100
    ) %>% 
  pivot_longer(
    perc_a:perc_b, 
    names_to = "group", 
    values_to = "values"
    ) %>% 
  
  ggplot(aes(x=values,fill=group)) + 
  geom_density() + 
  lims(x=c(-10,10))
```



```{r save_results}
results %>% write_rds(here("output", "interm", "results_list.rds"))
```

