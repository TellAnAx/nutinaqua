---
title: "Nutrient Contribution"
subtitle: "Assessment of contributions based on estimated assumptions"
author: "Anıl A. Tellbüscher"
date: "Last updated: `r format(Sys.Date(), '%d.%m.%Y')`"
output: 
  pdf_document:
    includes:
      in_header: ../latex/preamble.tex
    toc: true
    keep_tex: true
---

```{r setup, include=FALSE}
# RMarkdown options
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	include = FALSE
)

# R options
options(knitr.kable.NA = "", 
        digits = 3)

# Load packages
library(here)
library(rlang)
library(readxl)
library(tidyverse)
library(httr)
library(rstatix)
library(NADA)
library(PeriodicTable)
library(ggmap)
library(ggridges)
library(ggthemes)
library(gdata)
library(viridis)
library(RColorBrewer)
library(bookdown)
library(png)
library(tellbuschR) # Install from GitHub TellAnAx/tellbuschR with GitHub token for authentication

# Load functions
source(here("R", "plot_functions.R"))
source(here("R", "helper_functions.R"))
```

\newpage

# Data import

|File|Content|
|---|---|
|Feed composition APO-SUB-2.xlsx|Composition data of commercial and experimental fish feeds|
|Water quality APO-SUB-2.xlsx|Composition data of tap and rain water|
|IAFFD FICD.xlsx|Composition of aquafeed raw materials; data downloaded from www.iaffd.com|



```{r import_data}
source(here("R", "import_data.R"))
```



# Data wrangling

```{r model_system}
source(here("R", "assumptions.R"))
```

```{r data_wrangling}
source(here("R", "data_wrangling.R"))
```

```{r plot_functions}
source(here("R", "plot_functions.R"))
```

## Feed





## Water

- outliers for rain water were removed



## Alkalinity supplements





# Results

```{r}
results <- list()
tables <- list()
```



## Feed


```{r}
data$feed_cleaned <- data$feed[[1]] %>% 
  
  # remove broodstock feeds
  filter(feed_cat3 != "broodstock") %>% 
  
  # create additional data identifier
  mutate(
    N_gkg = CP*1e3/6.25,
    cat2 = case_when(
      cat1=="commercial" ~ "commercial",
      cat1=="experimental" ~ "experimental"
      ),
    cat2 = if_else(grepl("Tacon", ref_id),"old",cat2),
    cat2 = if_else(grepl("aquaponic",target_system),"aquaponic",cat2)
    ) %>% 
  
  # keep only necessary data
  select(cat2, ref_id, treat_id, P_gkg:Cu_mgkg, N_gkg) %>% 
  
  # write data for statistical analysis
  write_rds(here("output", "interm", "feed_stattest.rds")) %>% 
  
  create_plot_data() %>% 
  
  # remove missing data
  drop_na(value) %>% 
  
  # split single column into two columns
  separate(name, into = c("substance", "unit"), sep = "_") %>%
  
  # Unit conversion
  mutate(
    value = if_else(unit == "mgkg", value*1e-3, value), 
    unit = if_else(unit == "mgkg", "gkg", unit)
    #molmass = map_dbl(convert_formula(substance), ~ sum(mass(.x))),
    #value = value/molmass, # g/kg -> mol/kg
    #unit = "molkg",
    #value = value*1e3, # mol/kg -> mmol/kg
    #unit = "mmolkg"
    ) %>% 
  write_rds(here("output", "interm", "feed_cleaned.rds"))
```

```{r}
data$feed <- data$feed[[1]]

results$n_feeds_commercial <- data$feed %>% filter(cat1 == "commercial" & ref_id == "datasheet") %>% nrow()

results$n_feeds_commercial_literature <- data$feed %>% filter(cat1 == "commercial" & !ref_id %in% c("datasheet", "Tacon1983")) %>% nrow()

results$n_feeds_experimental <- data$feed %>% filter(cat1 == "experimental") %>% nrow()
```


```{r}
tables$feed_summary_long <- read_rds(here("output", "interm", "feed_cleaned.rds")) %>% 
  
  # Calculate summary statistics
  group_by(cat2, substance, unit) %>% 
  summarise(
    n = n(),
    min = min(value, na.rm = T),
    mean = mean(value, na.rm = T),
    sd = sd(value, na.rm = T),
    cv = sd/mean,
    max = max(value, na.rm = T)
  ) %>% 
  
  rename(category = "cat2") %>% 
  write_csv(here("output", "tables", "feed_summary_long.csv"))
  

tables$feed_summary_wide <- tables$feed_summary_long %>% 
  pivot_wider(names_from = category, values_from = c(n, min, mean, sd, cv, max)) %>%
  write_csv(here("output", "tables", "feed_summary_wide.csv"))
```

```{r include=TRUE}
knitr::kable(tables$feed_summary_long,
             #format.args = list(digits = 4),
             caption = "")
```



### Statistics

```{r feed_statistics}
data$feed_stat <- read_rds(here("output", "interm", "feed_cleaned.rds")) %>% 
  filter(cat2 == "commercial") %>% 
  print()

# Calculate mean inclusion rates and use as mu for t-test
read_rds(here("output", "interm", "feed_cleaned.rds")) %>% 
  filter(cat2 == "old") %>% 
  drop_na(value) %>% 
  group_by(substance, unit) %>% 
  summarise(mean = mean(value)) %>%
  print()




# PHOSPHORUS
# n = 68; enough data for reliable comparison
results$feed_comp_P <- data$feed_stat %>% filter(substance == "P") %>% 
  t_test(value ~ 1, mu = 524.714, detailed = T) %>% print()

# Change in P
results$feed_P_decrease_old_new <- (1 - 524.714/377) * 100

# CALCIUM
# n = 5; 
results$feed_comp_P <- data$feed_stat %>% filter(substance == "Ca") %>% 
  t_test(value ~ 1, mu = 565.801) %>% print()
```

- reliable comparison of nutrient inclusion is only possible for P, considering the number of observations in the dataset.
- comparison of commercial data with aquaponics or experimental feed is also not meaningful due to low sample size

- P: Aquaponics feeds are richer in P compared with commercial feeds and also compared with experimental diets (Tukey test: p < 0.05). The smallest difference was found between aquaponics and old diets. The difference between them is non-significant. 



### Feed composition


```{r}
data$plot <- read_rds(here("output", "interm", "feed_cleaned.rds")) %>% 
  mutate(
    substance = fct_relevel(substance, "N", "P", "K", "Ca", "Mg", "S", "Fe", "Cu", "Zn"),
    category = fct_relevel(cat2, "old", "commercial", "experimental", "aquaponic"),
    category = fct_recode(category,  past = "old", present = "commercial", AP = "aquaponic", EXP = "experimental")
  )


data$plot_feed_labels <- read_csv(here("output", "tables", "feed_summary_long.csv")) %>% 
  mutate(category = fct_recode(category,  past = "old", present = "commercial", AP = "aquaponic", EXP = "experimental"),
         n = paste("n =", n),
         x_axis = min + 0.1*max,
         substance = as.factor(substance)) %>% 
  #drop_na() %>% 
  select(category, substance, n, x_axis)


data$plot %>% 
  ggplot(aes(y = fct_rev(category), x = value, 
             fill = category)) + 
  geom_boxplot() +
  facet_wrap(facets = vars(substance), scales = "free") + 
  scale_fill_colorblind() +
  geom_label(
    data = data$plot_feed_labels,
    aes(x = Inf, y = category, label = n), alpha = 0.5, fill = "white", nudge_y = 0.3, hjust = 1) +
  #scale_fill_manual(values = c("grey", "lightblue", "gold", "lightgreen")) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.y = element_text(angle = 45, 
                                   hjust = 1,
                                   size = 10),
        strip.text = element_text(face = "bold")) +
  labs(y = "",
       x = "Inclusion rate (g/kg)",
       fill = "class")
  
ggsave(here("output", "plots", "feed.png"))
```


```{r include=TRUE}
knitr::include_graphics(here("output", "plots", "feed.png"))
```



```{r, eval=FALSE, include=FALSE}
data$feed_stat <- read_rds(here("output", "interm", "feed_stattest.rds"))

col_names <- colnames(data$feed_stat)
data$feed_stat$cat2


for(name in 2:length(col_names)) {
  print(name)
  
  data$feed_stat %>% 
    tukey_hsd()
    
  #data$feed_stat %>% 
    tukey_hsd(data$feed_stat[,name] ~ data$feed_stat$cat2) %>% print()
  
  if(!is.na(data$feed_stat[,name])){ # (FIXIT) returns vector instead of single logical
    tukey_hsd(data$feed_stat[,name] ~ data$feed_stat$cat2) %>% print()
  } else {
    next
  }
}
```



```{r feed_tukey, eval=FALSE}
stat_results <- list()
substances <- unique(data$feed_cleaned$substance)

for(i in 1:length(substances)) {
  stat_results[[i]] <- data$feed_cleaned %>% 
  filter(substance == substances[i]) %>% 
  rstatix::tukey_hsd(value~cat2)
}
names(stat_results) <- substances
```

















### Feedstuff composition

```{r}
data$feedstuff <- data$iaffd_overview[[1]] %>% 
  
  # join with XXX
  left_join(data$iaffd_composition[[1]], by = c("code","description")) %>% 
  
  # Data cleaning
  select(-c("code", "winfeed.x", "winfeed.y")) %>% 
  mutate(description = str_extract(description, "^[^,]+")) %>% 
  drop_na(cat1) %>%
  
  mutate(
    class = case_when(
      cat1=="animal"&grepl("[Ff]ish", cat2) ~ "fish",
      grepl("[Cc]rustacean", cat2) ~ "crustacean",
      cat1=="animal"&cat2=="insect" ~ "insect",
      grepl("[Mm]icro", cat1) ~ "microbial",
      grepl("[Mm]ammal", cat2) ~ "mammal",
      grepl("[Pp]oultry", cat2) ~ "poultry",
      grepl("[Ll]egumes", cat2) ~ "legume",
      grepl("[Gg]rains", cat2) ~ "grain",
      cat2=="Roots and tubers" ~ "roots"
    ),
    
    class = fct_relevel(class, 
                        "fish", "crustacean", "mammal", "poultry", "legume", "grain", "roots", "insect", "microbial"),
    
    colclass = case_when(
      class %in% c("fish", "crustacean") ~ "aquatic",
      class %in% c("mammal", "poultry") ~ "terrestrial",
      class %in% c("legume", "grain", "roots") ~ "plant",
      class == "insect" ~ "insect",
      class == "microbial" ~ "microbial"
    ) 
  ) %>% 
  drop_na(class) %>% 
  
  # multiply all percentages by 10
  mutate(
    across(contains("(%)"), ~ . * 10),
    unit = "gkg") %>% 
  
  write_rds(here("output", "interm", "feedstuff.rds"))
```
  
```{r}
data$feedstuff_cleaned <- read_rds(here("output", "interm", "feedstuff.rds")) %>% 
  
  pivot_longer(`Dry Matter (%)`:`SID Tyr - poultry (%)`,
               names_to = "analyte", values_to = "value") %>% 
  
  filter(grepl("Protein", analyte) | 
           grepl("Potassium", analyte) | 
           grepl("Phosphorus", analyte) | 
           grepl("Iron", analyte) | 
           grepl("Manganese", analyte) | 
           grepl("Zinc", analyte)) %>% 
  
  
  select(c(description:origin, class:value)) %>% 
  
  mutate(analyte = str_remove(analyte, " \\(.*"),
         analyte = fct_recode(analyte, 
                              `N (g/kg)` = "Crude  Protein", `P (g/kg)` = "Phosphorus", 
                              `K (g/kg)` = "Potassium", `Fe (mg/kg)` = "Iron", 
                              `Mn (mg/kg)` = "Manganese", `Zn (mg/kg)` = "Zinc"),
         value = if_else(analyte == "N", value/6.25, value)) %>% # convert CP to N
  
  select(-c(description, origin, cat2, cat3)) %>% 
  
  rename(cat3 = "class", cat2 = "colclass") %>% 
  
  mutate_if(is.character, as.factor) %>% 
  
  # crop dataset
  
    # remove zeros because they produce non-finite values on log scales and interfere with quantiles
  filter(value > 0) %>% 
  
  # now remove all values below or above 1.5xIQR
  group_by(analyte) %>%
  filter(between(value, quantile(value, 0.25) - 1.5*IQR(value), quantile(value, 0.75) + 1.5*IQR(value))) %>% 
  
  # remove Fe outlier
  #filter(!(analyte == "Fe (mg/kg)" & value < 0.02)) %>% 
  # remove Zn outlier
  #filter(!(analyte == "Zn (mg/kg)" & value < 5)) %>% 
  
  write_rds(here("output", "interm", "feedstuff_cleaned.rds"))
```

```{r}
tables$feedstuff_summary_long <- read_rds(here("output", "interm", "feedstuff_cleaned.rds")) %>% 
  group_by(cat2, analyte) %>% 
  summarise(n = n(), 
            mean = mean(value),
            sd = sd(value),
            cv = sd/mean) %>% 
  
  write_csv(here("output", "tables", "feedstuff_summary_long.csv"))

tables$feedstuff_summary_wide <- tables$feedstuff_summary_long %>% 
  pivot_wider(
    names_from = "cat2",
    values_from = c("n", "mean", "sd", "cv"),
    names_sort = TRUE
  ) %>% 
  
  write_csv(here("output", "tables", "feedstuff_summary_wide.csv"))
```

```{r include=TRUE}
knitr::kable(tables$feedstuff_summary_long,
             caption = "")
```

```{r}
library(onewaytests)

data$feedstuff_stattest <- read_rds(here("output", "interm", "feedstuff_cleaned.rds"))

# 
#paircomp(bf.test(value ~ cat3, data$feedstuff_stattest))

# 
#paircomp(bf.test(value ~ cat2, data$feedstuff_stattest))
```

```{r}
source(here("R", "plots", "feed_plots.R"))
```

```{r include=TRUE}
knitr::include_graphics(here("output", "plots", "feedstuff_composition.png"))
```







## Water

### Data origin

```{r create_water_map}
source(here("R", "plots", "map_plots.R"))
```

```{r include=TRUE, fig.cap = "Origins of data included into the water dataset. Blue dots: Drinking water analysis reports. Red dots: Rain water analyses."}
knitr::include_graphics(here("output", "plots", "map.png"))
```


```{r}
results$n_wateranalysis <- nrow(gps_coordinates[,which("source" == "tap")])
results$n_wateranalysis_countries <- length(unique(gps_coordinates$country))
```



### Tap water

```{r}
results$n_observations_water_tap <- filter(data$water_cleaned, source == "tap") %>% nrow()
```

```{r tap}
data$water_cleaned_tap <- read_rds(here("output", "interm", "water_cleaned.rds")) %>% 
  
  # select only tap water
  filter(source == "tap") %>% 
  
  # remove irrelevant variables
  select(-c(ref_id:`EC_uS_cm_25degC`)) %>% 
  
  # convert concentrations
  mutate(
    NO3_mgL = sum(c(NO3_mgL*0.23, NO2_mgL*0.3, NH4_mgL*0.7), na.rm = TRUE), # convert to elemental N (TN_dissolved)    
    SO4_mgL = SO4_mgL*0.3, # convert SO4 to elemental S
    PO4_mgL = PO4_mgL*0.33 # convert PO4 to elemental P
  ) %>% 
  
  # convert to longtable
  pivot_longer(
    everything(),
  names_to = c("analyte", ".value"),
  names_pattern = "(.+)_(.+)*"
    ) %>% 
  
  rename(conc = "mgL") %>% 
  
  # convert units
  mutate(
    conc = conc*1e-3, # mg/L -> g/L
    molmass = map_dbl(convert_formula(analyte), ~ sum(mass(.x))),
    conc = conc/molmass, # g/L -> mol/L
    unit = "molL",
    conc = conc*1e6, # mol/L -> µmol/L
    unit = "µmolL",
    analyte = as.factor(analyte),
    belowLimit = as.logical(belowLimit)
    ) %>% 
  
  drop_na() %>% 
  
  # summarise data
  group_by(analyte, unit) %>% 
  summarise(
    n = n(),
    min = min(conc, na.rm = TRUE),
    conf.025 = mean(cenmle(conc, belowLimit, dist = 'gaussian'))[c(3)],
    meanconf = mean(cenmle(conc, belowLimit, dist = 'gaussian'))[c(1)],
    sd = sd(conc),
    cv = sd/meanconf,
    conf.975 = mean(cenmle(conc, belowLimit, dist = 'gaussian'))[c(4)],
    max = max(conc, na.rm = TRUE)
    ) %>% 
  
  mutate(
    analyte = if_else(analyte == "NO3", "N", analyte), # rename after conversion
    analyte = if_else(analyte == "SO4", "S", analyte), # rename after conversion
    analyte = if_else(analyte == "PO4", "P", analyte) # rename after conversion    
  ) %>% 
    
  # control number of digits
  #mutate(across(where(is.numeric), ~ num(., digits = 3))) %>% 
  
  arrange(desc(meanconf), cv) %>% 
  
  filter(!analyte %in% c("NH4", "NO2", "NO3", "TOC")) %>%
    
  write_rds(here("output", "interm", "water_cleaned_tap.rds"))
```



```{r}
tables$water_tap <- read_rds(here("output", "interm", "water_cleaned_tap.rds")) %>% 
  select(analyte, unit, n, min, meanconf, sd, cv, max) %>% 
  table_styler() %>% 
  rename(mean = "meanconf") %>% 
  write_csv(here("output", "tables", "water_tap.csv"))
```

```{r include=TRUE}
knitr::kable(tables$water_tap,
             caption = paste0("Summary statistics of the chemical composition of tap water. Data was compiled from analysis reports of water supply companies (n = ", results$n_observations_water_tap, "). Mean values were estimated using accepted methods for censored data (Helsel, 2012). N is the sum of all nitrogenous species."))
```





### Rain water

```{r}
results$n_observations_water_rain <- read_rds(here("output", "interm", "water_cleaned.rds")) %>% 
  filter(source == "rain") %>% nrow()
```


```{r}
data$water_cleaned_rain <- read_rds(here("output", "interm", "water_cleaned.rds")) %>% 
  
  # remove tap water data
  filter(source == "rain") %>% 
  
  # remove irrelevant variables
  select(-matches("belowLimit")) %>% 
  select(-("ref_id":"aquaponics")) %>% 
  select(-c(pH, EC_uS_cm_25degC)) %>% 
  
  rowwise() %>% 
    # convert concentrations
  mutate(
    N_mgL = sum(c(NO3_mgL*0.23, NO2_mgL*0.3, NH4_mgL*0.7), na.rm = TRUE), # convert to elemental N (TN_dissolved)
    S_mgL = SO4_mgL*0.3, # convert SO4 to elemental S
    P_mgL = PO4_mgL*0.33 # convert PO4 to elemental P
  ) %>% 
  
  # convert to long format
  pivot_longer(
    everything(),
    names_to = "names",
    values_to = "conc"
  ) %>% 
  separate(names, into = c("analyte", "unit"), sep = "_") %>% 
  
  # convert units
  mutate(
    conc = conc*1e-3, # mg/L -> g/L
    unit = "gL",
    molmass = map_dbl(convert_formula(analyte), ~ sum(mass(.x))),
    conc = conc/molmass, # g/L -> mol/L
    unit = "molL",
    conc = conc*1e6, # mol/L -> µmol/L
    unit = "µmolL"
  ) %>% 
  
  
  filter(!analyte %in% c("TOC", "NH4", "NO2", "NO3", "PO4", "SO4")) %>% 
  
  drop_na(conc) %>% 
  
  # remove outliers
  group_by(analyte) %>% 
  filter(between(conc, quantile(conc, 0.25) - 1.5*IQR(conc), quantile(conc, 0.75) + 1.5*IQR(conc))) %>% 

  write_rds(here("output", "interm", "water_cleaned_rain.rds"))
```

```{r}
source(here("R", "plots", "water_plots.R"))
```

```{r}
knitr::include_graphics(here("output", "plots", "water_rain.png"))
```



```{r}
#
results$n_observations_water_rain <- filter(data$water_cleaned, source == "rain") %>% nrow()

# set threshold for minimum number of observations in the dataset
# for being considered for further analysis
results$water_rain_threshold_removal <- 5
```

```{r}
tables$water_rain <- read_rds(here("output", "interm", "water_cleaned_rain.rds")) %>% 
  
  group_by(analyte, unit) %>% 
  summarise(
    n = n(),
    min = min(conc),
    Q1 = quantile(conc, 0.25),
    mean = mean(conc),
    sd = sd(conc),
    cv = sd/mean,
    Q3 = quantile(conc, 0.75),
    max = max(conc)
  ) %>% 
  
  # remove data with few observations
  filter(n > results$water_rain_threshold_removal) %>% 
  
  select(-c(Q1, Q3)) %>% 
  print() %>% 
  write_csv(here("output", "tables", "water_rain.csv"))
```

```{r include=TRUE}
knitr::kable(tables$water_rain,
             caption = paste0("Summary statistics of rainwater composition data (n = ", results$n_observations_water_rain, "). Analytes with less than ", results$water_rain_threshold_removal, " dataset records were removed. Outliers were identified by calculating the interquartile range (IQR). Values > 1.5 x IQR were removed from the dataset."))
```



### Combined

```{r}
data$water_combined_tap <- read_rds(here("output", "interm", "water_cleaned_tap.rds")) %>% 
  select(analyte, unit, conf.025, meanconf, conf.975)

data$water_combined_rain <- read_csv(here("output", "tables", "water_rain.csv")) %>% 
  select(analyte, unit, mean)



tables$water_combined <- data$water_combined_tap %>% 
  left_join(data$water_combined_rain) %>% 
  
  table_styler() %>% 
  
  mutate(significance = case_when(
    mean < conf.025 ~ "lower",
    mean > conf.025 & mean < conf.975 ~ "not significant",
    mean > conf.975 ~ "higher"
    ),
    `tap:rain ratio` = round(meanconf/mean)
    ) %>% 
  
  select(-c(conf.025, conf.975)) %>% 
  
  rename(mean_tap = "meanconf", mean_rain = "mean") %>% 
  
  write_csv(here("output", "tables", "water_combined.csv"))
```

```{r include=TRUE}
knitr::kable(tables$water_combined,
             caption = paste0(""))
```

- All substance concentrations that are known for both tap and rain water are significantly lower in rain water (p < 0.05).




## Alkalinity supplements








# Nutrient contribution


## Initial assumptions

```{r input_variables}
source(here("R", "assumptions.R"))
```

We assume a recirculation aquaculture system (RAS) has a total volume of `r print(totalV)` \si{\cubicm} of which `r print(rearingV)` \si{\cubicm} are used as rearing volume for the stock. Furthermore, we assume a stocking density of `r print(SD)` \si{\kg\per\cubicm}, referred to the rearing volume of the system. The feeding rate shall be set to `r print(FR)` \si{\p\per\d} of the total biomass and a water exchange rate of `r print(ER)` \si{\p\per\d} of the total system volume shall be maintained.

```{r echo=TRUE, results=FALSE}
# Calculate outputs
BM <- rearingV * SD       # Total biomass of stock (kg)
dailyFeed <- BM * (FR / 100)             # Total mass of feed per day (kg/day)
dailyFreshwater <- totalV * (ER / 100)   # Total volume of freshwater per day (m^3/day)
waterEx_perFeed <- (dailyFreshwater * 1e3) / dailyFeed   # Water exchange per feed unit (L/kg/day)
```

Based on these inputs, a biomass of `r print(BM)` \si{\kg}, a total weight of `r print(dailyFeed)` \si{\kg} feed fed per day, a daily exchanged volume of `r print(dailyFreshwater)` \si{\cubicm\per\d} freshwater and `r print(waterEx_perFeed)` \si{\L\per\kg} exchanged water per weight unit feed fed is calculated.

```{r include=FALSE}
tables$assumptions <- tibble(
  Parameter = c(
  'Stocking density (kg/m^3)'
  ,'Feeding rate (%)'
  ,'Total biomass (kg)'
  ,'Daily feed fed (kg/day)'
  ,'Rearing unit volume (m^3)'
  ,'Total volume (m^3)'
  ,'Daily water exchange rate (%/m^3/day)'
  ,'Daily freshwater volume (m^3/day)'
  ,'Freshwater per feed (L/kg)'),
  Values = c(SD, FR, BM, dailyFeed, rearingV, totalV, ER, dailyFreshwater, waterEx_perFeed)) %>% 
  write_csv(here("output", "tables", "assumptions.csv"))
```

```{r table_assumptions}
knitr::kable(tables$assumptions,
             caption = "")
```


To estimate the mass contribution of source water and feed to the total amount of nutrients that are entering the system, it is assumed that the RAS operator is using tap water as freshwater source and analysis results from water treatment plants are thus taken as data input. Furthermore, the average of the nutrient profile of a number of commercial fish feeds is used.

## Data preparation

### Feed

```{r prepare_feed}
data$permutation_feed <- data$feed_cleaned %>% 
  filter(cat2 %in% c("commercial", "experimental")) %>% 
  mutate(feed = value/molmass,
         unit = "molkg") %>% 
  select(substance, unit, feed)
```



#### Consideration of digestibility and retention

Assumptions with regards to the digestibility of nutrients in the feeds are the following:

- **N** ADC ranging between 85-95%
- **P** ADC ranging between 35-45% [@Sugiura2018]
- all other nutrient ADC ranging between 45-55%



```{r create_digestibility_data}
data$permutation_feed_digestibility <- tibble(
  N = seq(0.85, 0.95, 0.05), 
  P = seq(0.35, 0.45, 0.05), # Sugiura et al., 2018
  K = seq(0.45, 0.55, 0.05),
  Ca = seq(0.45, 0.55, 0.05),
  Mg = seq(0.45, 0.55, 0.05),
  S = seq(0.45, 0.55, 0.05),
  B = seq(0.45, 0.55, 0.05),
  Fe = seq(0.45, 0.55, 0.05),
  Mn = seq(0.45, 0.55, 0.05),
  Cu = seq(0.45, 0.55, 0.05),
  Zn = seq(0.45, 0.55, 0.05)
) %>% 
  pivot_longer(everything(),
               names_to = "substance",
               values_to = "adc") %>% 
  write_rds(here("output", "interm", "digestibility.rds"))
```



**Retention** assumptions are based on [@Roy2022]. These were derived from Tilapia, though.

```{r}
data$permutation_feed_retention <- tibble(
  N = seq(0.45, 0.55, 0.05), # Roy et al., 2022
  P = seq(0.70, 0.80, 0.05), # Roy et al., 2022
  K = seq(0.45, 0.55, 0.05),
  Ca = seq(0.45, 0.55, 0.05),
  Mg = seq(0.80, 0.90, 0.05), # Roy et al., 2022
  S = seq(0.85, 0.95, 0.05), # Roy et al., 2022
  B = seq(0.45, 0.55, 0.05),
  Fe = seq(0.70, 0.80, 0.05), # Roy et al., 2022
  Mn = seq(0.65, 0.75, 0.05), # Roy et al., 2022
  Cu = seq(0.55, 0.65, 0.05), # Roy et al., 2022
  Zn = seq(0.60, 0.70, 0.05) # Roy et al., 2022
) %>% 
  pivot_longer(everything(),
               names_to = "substance",
               values_to = "retention") %>% 
  write_rds(here("output", "interm", "retention.rds"))
```

```{r}
data$permutation_feed_with_digestibility <- data$permutation_feed %>% 
    left_join(data$permutation_feed_digestibility, relationship = "many-to-many") %>% 
  left_join(data$permutation_feed_retention, relationship = "many-to-many") %>% 
  mutate(
    digestible = feed * adc,
    retained = digestible * retention,
    feed_excreted = feed - retained
  )
```

The amount of daily feed fed was normalised to 1 kg of feed instead of going for the initial assumptions. This makes it better comparable.

```{r}
# daily nutrient input via feed based on hypothetical RAS
data$permutation_feed_with_assumptions <- data$permutation_feed_with_digestibility %>% 
  mutate(feed_excreted_assumption = feed_excreted) %>% 
  
  select(substance, unit, feed_excreted_assumption) %>% 
  rename(feed = "feed_excreted_assumption") %>% 
  mutate(unit = "mol")
```



### Water

```{r}
dailyFreshwater <- c(10, 100, 1000) # L
```



#### Tap water

```{r}
data$permutation_water_tap_with_assumptions <- map_dfr(dailyFreshwater, ~{
  data$water_cleaned_tap %>% 
    pivot_longer(c(min, meanconf, max),
                 names_to = "name",
                 values_to = "conc") %>% 
    distinct(conc, .keep_all = TRUE) %>%
    mutate(
      water = conc * .x, # Multiply by the current value of dailyFreshwater
      unit = "µmol",
      water = water * 1e-6, # Convert µmol to mol
      unit = "mol"
    ) %>% 
    rename(substance = "analyte") %>% 
    select(substance, unit, water) %>%
    mutate(dailyFreshwater = .x) # Add a column to identify dailyFreshwater value
})
```






#### Rain water

```{r}
data$permutation_water_rain_with_assumptions <- map_dfr(dailyFreshwater, ~{
  data$water_cleaned_rain %>% 
    select(-molmass) %>% 
    mutate(
      water = conc * .x, # Multiply by the current value of dailyFreshwater
      unit = "µmol",
      water = water * 1e-6, # Convert µmol to mol
      unit = "mol"
    ) %>% 
    rename(substance = "analyte") %>% 
    select(substance, unit, water) %>%
    mutate(dailyFreshwater = .x) # Add a column to identify dailyFreshwater value
})
```






## Empirical probability analysis

### Without retention

```{r without_digestibility_tap, eval=FALSE}
data$permutation_feed %>% 
    mutate(feed = feed, # standardised to 1 kg feed
           unit = "mol") %>%
  left_join(data$permutation_water_tap_with_assumptions, 
            relationship = "many-to-many") %>% 
  
  mutate(
    sum = feed + water,
    prop_feed = feed/sum,
    prop_water = water/sum,
    perc_feed = prop_feed*100,
    perc_water = prop_water*100
    ) %>% 
  pivot_longer(c(perc_feed, perc_water),
               names_to = "source",
               values_to = "percentage") %>% 
  select(substance, unit, source, percentage) %>% 
  mutate(source = fct_recode(source, aquafeed = "perc_feed", `tap water` = "perc_water"),
         substance = fct_relevel(substance, "N", "P", "K", 
                              "Ca", "Mg", "S", 
                              "Fe", "Cu", "Zn")) %>%
  ggplot(aes(x = percentage, fill = source)) + 
  geom_density(alpha = .7) + 
  facet_wrap(facets = vars(substance), scales = "free") + 
  scale_fill_manual(values = c("brown", "lightblue")) +
  theme_bw() + 
  theme(legend.position = "top") +
  labs(x = "Percentage contribution",
       y = "Density of occurrence",
       title = "Digestibility not considered",
       fill = "Nutrient source")

ggsave(here("output", "plots", "permutation_no_digestibility.png"))
```

```{r eval=FALSE}
knitr::include_graphics(here("output", "plots", "permutation_no_digestibility.png"))
```



### Retention - Tap water

```{r}
data$permutation_with_assumptions_tap <- data$permutation_water_tap_with_assumptions %>% 
  left_join(data$permutation_feed_with_assumptions) %>% 
  
  mutate(
    sum = feed + water,
    prop_feed = feed/sum,
    prop_water = water/sum,
    perc_feed = prop_feed*100,
    perc_water = prop_water*100
    ) %>% 
  pivot_longer(c(perc_feed, perc_water),
               names_to = "source",
               values_to = "percentage") %>% 
  select(substance, unit, source, percentage, dailyFreshwater) %>% 
  filter(substance %in% c("N", "P", "K", "Ca", "Mg", "S", "Fe", "Cu", "Zn")) %>% 
  mutate(source = fct_recode(source, aquafeed = "perc_feed", `tap water` = "perc_water"),
         substance = fct_relevel(substance, "N", "P", "K", 
                              "Ca", "Mg", "S", 
                              "Fe", "Cu", "Zn")) %>%
  write_rds(here("output", "interm", "permutation_tap.rds"))
```

```{r}
read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(dailyFreshwater == 1000 & substance == "Zn") %>% 
  #t_test(percentage ~ source, var.equal = FALSE, paired = TRUE, conf.level = 0.1)
  kruskal_test(percentage ~ source)
```


```{r}
five_list <- read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed") %>% 
  group_by(substance, dailyFreshwater) %>% 
  summarise(quantile = quantile(percentage, .05))

median_list <- read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed") %>% 
  group_by(substance, dailyFreshwater) %>% 
  summarise(median = median(percentage))

ninetyfive_list <- read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed") %>% 
  group_by(substance, dailyFreshwater) %>% 
  summarise(quantile = quantile(percentage, .95))
```

```{r}
read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(dailyFreshwater == 100) %>% 
  ggplot(aes(x = percentage, fill = source)) + 
  geom_density(alpha = .5) + 
  facet_wrap(facets = vars(substance), scales = "free") + 
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "Percentage contribution",
       y = "Likelihood of observation")

ggsave(here("output", "plots", "permutation_tap_density.png"))
```

```{r}
read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed") %>% 
  ggplot(aes(x = percentage, fill = as.factor(dailyFreshwater))) + 
  geom_density(alpha = .5) + 
  
  #geom_vline(data = five_list, mapping = aes(xintercept = quantile, linetype = "longdash")) +
  geom_vline(data = median_list, mapping = aes(xintercept = median, linetype = "dashed")) +
  geom_vline(data = ninetyfive_list, mapping = aes(xintercept = quantile, linetype = "longdash")) +
  
  #facet_wrap(facets = vars(substance), scales = "free") + 
  facet_grid(rows = vars(substance), cols = vars(as.factor(dailyFreshwater)), scales = "free") +
  
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "Percentage contribution",
       y = "Likelihood of observation")

ggsave(here("output", "plots", "permutation_tap_density.png"))
```

```{r}
read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed") %>% 
  ggplot(aes(x = percentage, fill = as.factor(dailyFreshwater))) + 
  geom_histogram(position = position_dodge()) + 
  facet_wrap(facets = vars(substance), scales = "free") + 
  #scale_fill_manual(values = c("lightblue", "aquamarine2", "darkturquoise")) +
  theme_bw() + 
  theme(legend.position = "top") +
  labs(x = "Percentage contribution",
       y = "Count of occurrences",
       title = "Tap water",
       fill = "Makeup water (L/kg feed)")

ggsave(here("output", "plots", "permutation_tap_histogram.png"))
```

```{r}
read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed") %>% 
  ggplot(aes(x = percentage, color = as.factor(dailyFreshwater))) + 
  stat_ecdf(geom = "step") +
  
  #geom_vline(data = five_list, mapping = aes(xintercept = quantile, linetype = "longdash")) +
  geom_vline(data = median_list, mapping = aes(xintercept = median, linetype = "dashed")) +
  geom_vline(data = ninetyfive_list, mapping = aes(xintercept = quantile, linetype = "longdash")) +
  
  facet_grid(rows = vars(substance), cols = vars(as.factor(dailyFreshwater))) +
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "Percentage contribution",
       y = "Proportion of observations")

ggsave(here("output", "plots", "permutation_tap_ecdf.png"))
```





```{r include=FALSE, fig.cap="Distribution of the expected percentage contributions of fish feed and tap water to the total nutrient input in aquaculture facilities. Data were generated through permutation."}
knitr::include_graphics(here("output", "plots", "permutation_tap.png"))
```

```{r}
read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed" & dailyFreshwater == 100) %>% 
  ggplot(aes(x = percentage, y = substance, fill = as.factor(dailyFreshwater))) + 
  geom_density_ridges(alpha = .5) +
  scale_x_continuous(breaks = seq(0,100,10), 
                     labels = c("0","","20","","40","","60","","80","","100"),
                     limits = c(0,100)) +
  scale_fill_manual(values = c("lightblue")) +
  facet_wrap(facets = vars(dailyFreshwater)) + 
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "Contribution to nutrient input (%)",
       y = "Density")

ggsave(here("output", "plots", "permutation_tap_ridgeddensity.png"))
```

```{r}
results$n_combinations_tap <- read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed" & dailyFreshwater == 100) %>% nrow()
```


```{r}
read_rds(here("output", "interm", "permutation_tap.rds")) %>% 
  filter(source != "aquafeed") %>% 
  mutate(dailyFreshwater = as.character(dailyFreshwater),
         dailyFreshwater = fct_recode(dailyFreshwater,
                                      `50 L/kg` = "50",
                                      `100 L/kg` = "100",
                                      `1 000 L/kg` = "1000")) %>% 
  ggplot(aes(x = percentage, y = substance, fill = stat(quantile))) + 
  stat_density_ridges(quantile_lines = FALSE,
                      calc_ecdf = TRUE,
                      geom = "density_ridges_gradient",
                      quantiles = c(0.2, 0.4, 0.6, 0.8)) +
  scale_fill_manual(name = "Occurrence probability interval", 
                    values = c("white", "lightblue1", "lightblue3", "lightblue1", "white"),
                    labels = c("(0%, 20%]", "(20%, 40%]", "(40%, 60%]", "(60%, 80%]", "(80%, 100%]")) +
  scale_x_continuous(breaks = seq(0,100,10), 
                     labels = c("0","","20","","40","","60","","80","","100"),
                     limits = c(0,100)) +
  facet_wrap(facets = vars(dailyFreshwater)) + 
  theme_bw() + 
  theme(legend.position = "top") +
  labs(x = "Contribution to total nutrient input (%)",
       y = "")

ggsave(here("output", "plots", "permutation_tap_ridgeddensity_multiple.png"))
```

After consideration of nutrient digestibility, two scenarios occur:
1. still majority of nutrient input by feed
2. 
3. equal contribution of water and feed possible

- tap water can contribute a share of N comparable to aquafeeds in some cases
- the probability that the majority of K will originate from aquafeeds is 100%
- 


### Retention - Rain water

```{r}
data$permutation_with_assumptions_rain <- data$permutation_feed_with_assumptions %>% 
  left_join(data$permutation_water_rain_with_assumptions, 
            relationship = "many-to-many") %>% 
  
  mutate(
    sum = feed + water,
    prop_feed = feed/sum,
    prop_water = water/sum,
    perc_feed = prop_feed*100,
    perc_water = prop_water*100
    ) %>% 
  pivot_longer(c(perc_feed, perc_water),
               names_to = "source",
               values_to = "percentage") %>% 
  select(substance, unit, source, percentage, dailyFreshwater) %>% 
  filter(substance %in% c("N", "P", "K", "Ca", "Mg", "S", "Fe", "Cu", "Zn")) %>% 
  mutate(source = fct_recode(source, aquafeed = "perc_feed", `tap water` = "perc_water"),
         substance = fct_relevel(substance, "N", "P", "K", 
                              "Ca", "Mg", "S", 
                              "Fe", "Cu", "Zn")) %>%
  write_rds(here("output", "interm", "permutation_rain.rds"))
```

```{r}
five_list <- read_rds(here("output", "interm", "permutation_rain.rds")) %>% 
  filter(source != "aquafeed") %>% 
  group_by(substance, dailyFreshwater) %>% 
  summarise(quantile = quantile(percentage, .05))

median_list <- read_rds(here("output", "interm", "permutation_rain.rds")) %>% 
  filter(source != "aquafeed") %>% 
  group_by(substance, dailyFreshwater) %>% 
  summarise(median = median(percentage))

ninetyfive_list <- read_rds(here("output", "interm", "permutation_rain.rds")) %>% 
  filter(source != "aquafeed") %>% 
  group_by(substance, dailyFreshwater) %>% 
  summarise(quantile = quantile(percentage, .95))
```

```{r}
read_rds(here("output", "interm", "permutation_rain.rds")) %>% 
  filter(dailyFreshwater == 100) %>% 
  ggplot(aes(x = percentage, fill = source)) + 
  geom_density(alpha = .5) + 
  facet_wrap(facets = vars(substance), scales = "free") + 
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "Percentage contribution",
       y = "Likelihood of observation")

ggsave(here("output", "plots", "permutation_rain_density.png"))
```

```{r}
read_rds(here("output", "interm", "permutation_rain.rds")) %>% 
  filter(source != "aquafeed" & dailyFreshwater == 100) %>% 
  ggplot(aes(x = percentage, y = substance, fill = as.factor(dailyFreshwater))) + 
  geom_density_ridges(alpha = .5) +
  scale_x_continuous(breaks = seq(0,100,10), 
                     labels = c("0","","20","","40","","60","","80","","100"),
                     limits = c(0,100)) +
  scale_fill_manual(values = c("lightblue")) +
  facet_wrap(facets = vars(dailyFreshwater)) + 
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "Contribution to nutrient input (%)",
       y = "Density")

ggsave(here("output", "plots", "permutation_rain_ridgeddensity.png"))
```

```{r}
read_rds(here("output", "interm", "permutation_rain.rds")) %>% 
  filter(source != "aquafeed") %>% 
  mutate(dailyFreshwater = as.character(dailyFreshwater),
         dailyFreshwater = fct_recode(dailyFreshwater,
                                      `10 L/kg` = "10",
                                      `100 L/kg` = "100",
                                      `1 000 L/kg` = "1000")) %>% 
  ggplot(aes(x = percentage, y = substance, fill = stat(quantile))) + 
  stat_density_ridges(quantile_lines = FALSE,
                      calc_ecdf = TRUE,
                      geom = "density_ridges_gradient",
                      quantiles = c(0.2, 0.4, 0.6, 0.8)) +
  scale_fill_manual(name = "Occurrence probability interval", 
                    values = c("white", "lightblue1", "lightblue3", "lightblue1", "white"),
                    labels = c("(0%, 20%]", "(20%, 40%]", "(40%, 60%]", "(60%, 80%]", "(80%, 100%]")) +
  scale_x_continuous(breaks = seq(0,100,10), 
                     labels = c("0","","20","","40","","60","","80","","100"),
                     limits = c(0,100)) +
  facet_wrap(facets = vars(dailyFreshwater)) + 
  theme_bw() + 
  theme(legend.position = "top") +
  labs(x = "Contribution to total nutrient input (%)",
       y = "")

ggsave(here("output", "plots", "permutation_rain_ridgeddensity_multiple.png"))
```

```{r}
results$n_combinations_rain <- read_rds(here("output", "interm", "permutation_rain.rds")) %>% 
  filter(source != "aquafeed") %>% nrow() %>% print()
```




### Combined

```{r}
data$permutation_water_combined_with_assumptions <- data$permutation_water_tap_with_assumptions %>% 
  bind_rows(data$permutation_water_rain_with_assumptions, .id = "source2") %>%
  mutate(source2 = as.character(source2),
         source2 = fct_recode(source2, tap = "1", rain = "2"))

data$permutation_with_assumptions_combined <- data$permutation_water_combined_with_assumptions %>% 
  left_join(data$permutation_feed_with_assumptions) %>% 
  write_rds(here("output", "interm", "permutation_combined_absolute.rds"))

data$permutation_with_assumptions_combined %>%   
  mutate(
    sum = feed + water,
    prop_feed = feed/sum,
    prop_water = water/sum,
    perc_feed = prop_feed*100,
    perc_water = prop_water*100
    ) %>% 
  pivot_longer(c(perc_feed, perc_water),
               names_to = "source",
               values_to = "percentage") %>% 
  select(substance, unit, source, source2, percentage, dailyFreshwater) %>% 
  filter(substance %in% c("N", "P", "K", "Ca", "Mg", "S", "Fe", "Cu", "Zn")) %>% 
  mutate(source = fct_recode(source, aquafeed = "perc_feed", `water` = "perc_water")) %>%
  write_rds(here("output", "interm", "permutation_combined_percentage.rds"))
```

```{r include=TRUE}
read_rds(here("output", "interm", "permutation_combined_percentage.rds")) %>% 
  ungroup() %>% 
  filter(source != "aquafeed") %>% 
  mutate(dailyFreshwater = as.character(dailyFreshwater),
         dailyFreshwater = fct_recode(dailyFreshwater,
                                      `10 L/kg` = "10",
                                      `100 L/kg` = "100",
                                      `1000 L/kg` = "1000"),
         substance = fct_relevel(substance, "N", "P", "K", 
                                 "Ca", "Mg", "S", "Fe", "Cu", "Zn")) %>% 
  
  # Plot
  ggplot(aes(x = percentage, y = fct_rev(substance), fill = stat(quantile))) + 
  stat_density_ridges(quantile_lines = FALSE,
                      calc_ecdf = TRUE,
                      geom = "density_ridges_gradient",
                      quantiles = c(0.25, 0.5, 0.75)) +
  scale_fill_colorblind(name = "Prob. quantile", 
                        labels = c("(0%, 25%]", "(25%, 50%]", "(50%, 75%]", "(75%, 100%]")) +
  scale_x_continuous(breaks = seq(0,100,10), 
                     labels = c("0","","20","","40","","60","", "80", "","100"),
                     limits = c(0,100)) +
  facet_grid(cols = vars(dailyFreshwater), rows = vars(source2)) + 
  theme_bw() + 
  theme(legend.position = "top") +
  labs(x = "Share of total nutrient input (%)",
       y = "") %>% 
  print()

ggsave(here("output", "plots", "combination_combined_ridgeddensity_multiple.png"))
```

```{r}
read_rds(here("output", "interm", "permutation_combined_percentage.rds")) %>% 
  ungroup() %>% 
  filter(source != "aquafeed" & !dailyFreshwater %in% c("10", "1000")) %>% 
  mutate(dailyFreshwater = as.character(dailyFreshwater),
         dailyFreshwater = fct_recode(dailyFreshwater,
                                      #`10 L/kg` = "10",
                                      `100 L/kg` = "100"
                                      #`1000 L/kg` = "1000"
                                      ),
         substance = fct_relevel(substance, "N", "P", "K", 
                                 "Ca", "Mg", "S", "Fe", "Cu", "Zn")) %>% 
  filter(substance == "Mg", source2 == "tap") %>% 
  #summarise(mean(percentage)) %>% print()
  t_test(percentage ~ 1, mu = 10, alternative = "greater", conf.level = 0.9)
  
```

```{r data_variability}
data$variability_raw <- data$permutation_water_combined_with_assumptions %>% 
  left_join(data$permutation_feed_with_assumptions) %>%
  pivot_longer(cols = c(water, feed), names_to = "source", values_to = "value") %>% 
  filter(substance %in% c("N", "P", "K", "Ca", "Mg", "S", "Fe", "Cu", "Zn")) %>% 
  ungroup() %>% 
  mutate(source = if_else(source == "water", source2, source),
         substance = fct_relevel(substance, "N", "P", "K", 
                                 "Ca", "Mg", "S", "Fe", "Cu", "Zn")) %>% 
  filter(dailyFreshwater == 100)
  
data$variability <- data$variability_raw %>% 
  group_by(source, substance, dailyFreshwater) %>% 
  summarise(mean = mean(value),
            sd = sd(value),
            cv = sd/mean) %>% 
  write_rds(here("output", "interm", "cv.rds"))
```

```{r}
tables$variability <-  read_rds(here("output", "interm", "cv.rds")) %>% 
  select(source, substance, cv) %>% 
  pivot_wider(names_from = "source", values_from = "cv") %>% 
  write_csv(here("output", "tables", "table_variability.csv"))
```

```{r}
read_csv(here("output", "tables", "table_variability.csv")) %>% 
  mutate(`rain:feed` = rain/feed,
         `tap:feed` = tap/feed) %>% 
knitr::kable(caption = "Coefficients of variability for the contribution of different nutrient sources to the total nutrient budget in integrated freshwater aquaculture systems.",
             digits = 1)
```



```{r plot_variability, include=TRUE}
read_rds(here("output", "interm", "cv.rds")) %>% 
  ggplot(aes(y = fct_rev(substance), x = cv, fill = source)) + 
  geom_col(position = position_dodge()) + 
  scale_fill_colorblind() +
  #scale_fill_manual(values = c("brown", "lightblue", "blue"))+
  theme_bw() + 
  labs(
    x = "Coefficient of Variation",
    y = ""
  )

ggsave(here("output", "plots", "variability.png"))
```


It can be seen that tap water is the predominant source of variability in the results
Feed was found to have the lowest variability (\gls{cv} < 0.5) of all nutrient sources for the major nutrients (nitrogen, phosphorus, the earth alkaline metals, potassium, and sulfur). The variability in the mass fractions of transition metals in feeds, on the other hand, is significantly higher. However, the variability is always lower than that found for tap water sources.

The highest variability in the data can be found in tap water with exception of phosphorus, which is more variable in rain

```{r}
tables$water_combined_quantiles_tap <- read_rds(here("output", "interm", "permutation_combined_percentage.rds")) %>% 
  filter(source != "aquafeed") %>% 
  group_by(substance, source2, dailyFreshwater) %>% 
  summarise(
    median = median(percentage),
    `0-20` = quantile(percentage, 0.2),
    `20-40` = quantile(percentage, 0.4),
    `40-60` = quantile(percentage, 0.6),
    `60-80` = quantile(percentage, 0.8),
    `80-100` = quantile(percentage, 1)
  ) %>% 
  #filter(dailyFreshwater == 100 & source2 == "tap") %>% 
  #arrange(`80-100`) %>%
  write_csv(here("output", "tables", "table_water_contribution_quantiles_tap.csv"))
```

```{r table_quantiles_tap, include=TRUE}
knitr::kable(tables$water_combined_quantiles_tap,
             caption = "Quantiles of percentage contribution to the total nutrient input into an aquaculture system as shown in the figure before.")
```

```{r}
tables$water_combined_quantiles_rain <- read_rds(here("output", "interm", "permutation_combined_percentage.rds")) %>% 
  filter(source != "aquafeed" & dailyFreshwater != "1000") %>% 
  group_by(substance, source2, dailyFreshwater) %>% 
  summarise(
    median = median(percentage),
    `0-20` = quantile(percentage, 0.2),
    `20-40` = quantile(percentage, 0.4),
    `40-60` = quantile(percentage, 0.6),
    `60-80` = quantile(percentage, 0.8),
    `80-100` = quantile(percentage, 1)
  ) %>% 
  filter(dailyFreshwater == 100 & source2 == "rain") %>% 
    arrange(`80-100`) %>%
  write_csv(here("output", "tables", "table_water_contribution_quantiles_rain.csv"))
```

```{r table_quantiles_rain, include=TRUE}
knitr::kable(tables$water_combined_quantiles_rain,
             caption = "Quantiles of percentage contribution to the total nutrient input into an aquaculture system as shown in the figure before.")
```





## Alkalinity supplements

```{r}
stuff_stats <- read_rds(here("output", "interm", "permutation_combined_absolute.rds")) %>% 
  filter(source2 != "rain") %>% 
  pivot_longer(c("water", "feed"), names_to = "source", values_to = "value") %>% 
  #mutate(source = if_else(source == "water" & source2 =="tap", "tap", source),
  #       source = if_else(source == "water" & source2 =="rain", "rain", source)) %>% 
  group_by(source, substance, dailyFreshwater) %>% 
  summarise(
    #min = min(value),
    mean = mean(value)
    #max = max(value)
    ) %>% 
  drop_na()

alk_stats <- read_rds(here("output", "interm", "permutation_combined_absolute.rds")) %>% 
  filter(substance == "N") %>% 
  distinct(feed, source2, water, dailyFreshwater) %>% 
  ungroup() %>% 
  select(-substance) %>% 
  mutate(K = feed * 0.75,
         Ca = feed * 0.375,
         Mg = feed * 0.375) %>% 
  pivot_longer(K:Mg, names_to = "substance", values_to = "value") %>% 
  group_by(substance, dailyFreshwater) %>% 
  summarise(
    #min = min(value),
    mean = mean(value)
    #max = max(value)
    ) %>% 
  mutate(source = "alkalinity") %>% bind_rows(stuff_stats) %>%
  pivot_wider(names_from = "source", values_from = c("mean"), values_fill = 0) %>% 
  mutate(
    sum = alkalinity + feed + water,
    perc_alkalinity = alkalinity/sum * 100,
    perc_feed = feed/sum * 100,
    perc_water = water/sum * 100
  ) %>% 
  filter(substance %in% c("K", "Ca", "Mg")) %>% 
  select(-c(alkalinity, feed, water, sum)) %>% 
  arrange(dailyFreshwater) %>% 
  rename(`Substance` = "substance", `Makeup water` = "dailyFreshwater", `Alkalinity suppl.` = "perc_alkalinity", Feed = "perc_feed", Water = "perc_water") %>%
  write_csv(here("output", "tables", "alkalinity.csv"))
```

```{r include=TRUE}
knitr::kable(read_csv(here("output", "tables", "alkalinity.csv")),
             caption = "Percentage contribution of selected alkalinity supplements to the nutrient budget at different levels of makeup water supplied to the system.")
```





```{r save_results}
results %>% write_rds(here("output", "interm", "results_list.rds"))
```

