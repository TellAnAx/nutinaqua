---
title: "Nutrient Contribution"
subtitle: "Assessment of contributions based on estimated assumptions"
author: "Anıl A. Tellbüscher"
date: '2022-06-08'
output: html_document
---

```{r setup, include=FALSE}
# Load packages
library(here)
library(readxl)
library(tidyverse)
library(NADA)
library(rlang)
```



# Initial assumptions

```{r input_variables}
source(here("R", "assumptions.R"))
```

We assume a recirculation aquaculture system (RAS) has a total volume of `r print(totalV)` \si{\cubicm} of which `r print(rearingV)` \si{\cubicm} are used as rearing volume for the stock. Furthermore, we assume a stocking density of `r print(SD)` \si{\kg\per\cubicm}, referred to the rearing volume of the system. The feeding rate shall be set to `r print(FR)` \si{\p\per\d} of the total biomass and a water exchange rate of `r print(ER)` \si{\p\per\d} of the total system volume shall be maintained.

```{r echo=TRUE, results=FALSE}
# Calculate outputs
BM <- rearingV * SD       # Total biomass of stock (kg)
dailyFeed <- BM * (FR / 100)             # Total mass of feed per day (kg/day)
dailyFreshwater <- totalV * (ER / 100)   # Total volume of freshwater per day (m^3/day)
waterEx_perFeed <- (dailyFreshwater * 1e3) / dailyFeed   # Water exchange per feed unit (L/kg/day)
```

Based on these inputs, a biomass of `r print(BM)` \si{\kg}, a total weight of `r print(dailyFeed)` \si{\kg} feed fed per day, a daily exchanged volume of `r print(dailyFreshwater)` \si{\cubicm\per\d} freshwater and `r print(waterEx_perFeed)` \si{\L\per\kg} exchanged water per weight unit feed fed is calculated.

```{r include=FALSE}
results <- data.frame(Values = c(SD, FR, BM, dailyFeed, rearingV, totalV, ER, dailyFreshwater, waterEx_perFeed))

rownames(results) <- c(
  'Stocking density (kg/m^3)'
  ,'Feeding rate (%)'
  ,'Total biomass (kg)'
  ,'Daily feed fed (kg/day)'
  ,'Rearing unit volume (m^3)'
  ,'Total volume (m^3)'
  ,'Daily water exchange rate (%/m^3/day)'
  ,'Daily freshwater volume (m^3/day)'
  ,'Freshwater per feed (L/kg)'
)
```

```{r table_assumptions}
knitr::kable(results)
```





# Average contribution
To estimate the mass contribution of source water and feed to the total amount of nutrients that are entering the system, it is assumed that the RAS operator is using tap water as freshwater source and analysis results from water treatment plants are thus taken as data input. Furthermore, the average of the nutrient profile of a number of commercial fish feeds is used.


## Feed

```{r}
assumption_data_feed <- read_excel(
  here("data", "APO-masterfile_nutrients.xlsx"), 
  sheet = 'feedIN', skip = 1) %>% 
  mutate(FR = as.numeric(sub("%","",FR)) / 100,
         CP = as.numeric(sub("%","",CP)) / 100) %>% 
  filter(!is.na(CP) & 
           !is.na(FR) &
           feed_name != "") %>% 
  group_by(feed_name) %>% 
  summarise(
    #Reference_ID = Reference_ID,
    FR = mean(FR),
    CP = mean(CP)) 

head(assumption_data_feed)
```

```{r include=FALSE}
# Load nutrient data
data <- read.csv2("data/nutrient_contribution.csv")

# Convert classes
data[,1] <- factor(data[,1], levels = c('N', 'P', 'K', 'Ca', 'Mg', 'S', 'B', 'Fe', 'Mn', 'Zn', 'Cu', 'Mo', 'Ni'))
data[,2:5] <- apply(data[,2:5], 2, as.numeric)
```



```{r echo=FALSE}
print(data)
```

**To Do**
- Check average water quality data
- Check for more commercial feeds
- Group commercial feeds by fish species (is there a pattern?)


## Water

```{r}
read_excel(here("data", "APO - Water quality.xlsx"), sheet = "municipalTap", skip = 1) %>% 
  select(-c(Reference_ID:`EC_uS_cm_25degC`)) %>% 
  pivot_longer(
    everything(),
  names_to = c("nutrient", ".value"),
  names_pattern = "(.+)_(.+)*"
    ) %>% 
  mutate(nutrient = as.factor(nutrient),
         belowLimit = as.logical(belowLimit)) %>% 
  drop_na() %>% 
  filter(nutrient != "Al") %>% 
  group_by(nutrient) %>% 
  summarise(
    lconf = mean(cenmle(mgL, belowLimit, dist = 'gaussian'))[c(3)],
    mconf = mean(cenmle(mgL, belowLimit, dist = 'gaussian'))[c(1)],
    hconf = mean(cenmle(mgL, belowLimit, dist = 'gaussian'))[c(4)]
    )
```

